# 草屯美食轉轉樂 - 專案待辦事項

## 資料庫架構
- [x] 建立店家資料表 (restaurants)
- [x] 建立優惠券資料表 (coupons)
- [x] 建立優惠券兌換記錄表 (coupon_redemptions)
- [x] 建立轉盤使用記錄表 (spin_history)

## 後台管理系統
- [x] 店家管理頁面 - 新增/編輯/刪除店家
- [x] 店家營業時間設定介面
- [x] 優惠券管理頁面 - 新增/編輯/刪除優惠券
- [x] 使用者列表查看頁面

## 前台核心功能
- [x] 時間偵測與時段判斷邏輯 (早餐/午餐/下午茶/晚餐/消夜)
- [x] 店家篩選演算法 (根據當前時間與營業時間)
- [x] 互動式轉盤元件整合
- [x] 轉盤結果顯示頁面
- [x] 優惠券展示介面
- [x] Google Maps 導航按鈕功能

## 使用者系統
- [x] 使用者註冊/登入流程 (Manus OAuth)
- [x] 優惠券兌換按鈕與狀態管理
- [x] 兌換記錄追蹤

## 數據分析儀表板
- [x] 使用者統計 (總註冊數、活躍使用者)
- [x] 轉盤使用統計 (各時段使用次數)
- [x] 店家抽出次數排行
- [x] 優惠券兌換率分析
- [x] 圖表視覺化呈現

## 測試與品質保證
- [x] 時間篩選邏輯單元測試
- [x] 導航功能測試
- [x] 不同時段的整合測試
- [x] 手機響應式設計測試

## 部署與交付
- [x] 建立專案檢查點
- [x] 部署到正式環境
- [x] 提供公開存取網址

## 營業時間介面優化
- [x] 將 JSON 文字框改為每週七天的個別輸入框
- [x] 支援每天設定開始與結束時間
- [x] 支援公休日設定
- [x] 自動轉換為 JSON 格式儲存

## LINE Login 整合
- [x] 設定 LINE Login 環境變數（Channel ID, Channel Secret）
- [x] 建立 LINE Login 後端驗證邏輯
- [x] 整合 LINE Login SDK 到前端
- [x] 更新登入頁面，新增 LINE 登入按鈕
- [x] 測試 LINE Login 流程
- [ ] 在 LINE Developers Console 設定 Callback URL

## 大規模功能擴充

### 後端 API 開發
- [x] 簽到系統 API (checkInRouter)
- [x] 轉盤限制 API (spinLimitRouter)
- [x] 推播訊息 API (pushNotificationRouter)
- [x] 管理員管理 API (adminRouter)
- [x] 店家照片上傳 API
- [x] 優惠券圖片上傳 API
- [x] 背景圖片管理 API
- [x] 資料庫查詢函式擴充

### 首頁改版
- [x] 保留轉盤功能
- [x] 新增合作店家列表區塊
- [x] 顯示當前時段營業中的店家
- [x] 店家卡片顯示：店名 + 照片 + 地址
- [x] 距離篩選功能（使用者定位 vs 店家地址）
- [x] 點擊店家卡片直接開啟 Google Maps 導航
- [x] 使用 Haversine 公式計算距離

### 管理員權限管理
- [ ] 新增「管理員管理」頁面
- [ ] 顯示所有管理員列表
- [ ] 超級管理員可新增/移除管理員權限
- [ ] 一般管理員可管理所有店家與優惠券

### 營業時間介面優化
- [ ] 使用視覺化時間選擇器（Time Picker）
- [ ] 新增時間軸視覺化顯示
- [ ] 支援拖曳調整營業時間
- [ ] 新增快速範本（全天營業、午晚餐時段、週末特別時段）

### 背景圖片自訂
- [ ] 管理員可上傳背景圖片
- [ ] 套用到所有頁面
- [ ] 自動添加深色遮罩確保文字可讀性

### 優惠券圖片上傳
- [ ] 管理員可上傳優惠券圖片（選填）
- [ ] 未上傳時顯示預設樣式

### 店家照片上傳
- [ ] 在店家管理中新增照片上傳功能
- [ ] 店家列表顯示店家照片

### 推播訊息功能
- [x] 推播對象：所有使用者
- [x] 推播內容：文字 + 優惠券圖片
- [ ] 站內通知系統
- [ ] 支援定時發送

### 轉盤與優惠券限制
- [ ] 每個時段獨立計算轉盤次數（各 2 次）
- [ ] 每天最多抽中 10 張優惠券
- [ ] 未兌換優惠券在 24:00 自動失效
- [ ] 每日 00:00 重置計數

### 每日簽到獎勵
- [ ] 簽到獎勵：第 1 天 +1 次轉盤機會
- [ ] 連續簽到 7 天獲得 5 折專屬優惠券
- [ ] 中斷後重新計算連續天數
- [ ] 簽到按鈕位於首頁顯眼位置
- [ ] 簽到日曆視覺化顯示

## 優惠券介面調整
- [x] 移除「有效期限」日期選擇器欄位
- [x] 保留「是否為簽到獎勵優惠券」開關
- [x] 更新優惠券新增/編輯邏輯
- [x] 更新優惠券列表顯示欄位

## 簽到功能開發
- [x] 首頁右上角新增簽到按鈕
- [x] 簽到對話框元件
- [x] 簽到成功動畫（彩帶效果）
- [x] 簽到成功音效（Web Audio API）
- [x] 簽到日曆視覺化（顯示本月簽到記錄）
- [x] 連續簽到進度條（顯示距離 7 天獎勵還差幾天）
- [x] 簽到獎勵提示（連續 7 天獲得專屬優惠券）

## 轉盤顯示問題修復
- [x] 修復 Canvas 轉盤未正確渲染的問題
- [x] 確保轉盤在頁面載入時正確繪製
- [x] 測試轉盤旋轉動畫

## 轉盤音效整合
- [x] 將音效檔案複製到專案 public 目錄
- [x] 在 SpinWheel 元件中載入音效
- [x] 轉盤開始旋轉時播放旋轉音效
- [x] 轉盤停止時播放中獎音效
- [x] 測試音效播放功能

## 轉盤圖片上傳功能
- [x] 在 system_settings 表中使用 wheel_image 鍵值
- [x] 建立轉盤圖片上傳 API (uploadWheelImage, getWheelImage)
- [x] 在管理後台新增「轉盤設定」頁籤
- [x] 修改 SpinWheel 元件，支援使用自訂圖片或 Canvas 繪製
- [x] Home.tsx 整合轉盤圖片查詢
- [x] 建立 WheelImageSettings 頁面元件

## 使用者回報問題修復
- [x] 店家管理頁面：新增店家照片上傳功能
- [x] 優惠券管理頁面：新增優惠券圖片上傳功能
- [x] 使用者管理頁面：顯示使用者詳細資訊
- [x] 管理員權限管理：開發管理員列表與權限管理功能

## 圖片上傳功能改進
- [x] 建立後端圖片上傳 API（整合 S3 storagePut）
- [x] 店家管理：將照片網址輸入框改為檔案上傳按鈕
- [x] 優惠券管理：將圖片網址輸入框改為檔案上傳按鈕
- [x] 新增圖片格式驗證（jpg, png, webp）
- [x] 新增圖片尺寸驗證（檔案大小限制 5MB）
- [x] 顯示上傳進度與預覽圖片
- [x] 測試圖片上傳功能

## 背景圖片自訂功能
- [x] 建立後端背景圖片上傳 API（整合 S3 storagePut）
- [x] 在 system_settings 表中儲存背景圖片網址
- [x] 在轉盤設定頁面新增背景圖片上傳區塊
- [x] 修改前台頁面（Home.tsx）動態載入背景圖片
- [x] 修改管理後台（DashboardLayout.tsx）動態載入背景圖片
- [x] 自動添加深色遮罩確保文字可讀性
- [x] 支援清除背景圖片，恢復預設樣式
- [x] 測試背景圖片上傳與顯示功能

## 側邊欄按鈕修復
- [x] 檢查 DashboardLayout 中的 Page 1 和 Page 2 按鈕
- [x] 移除無用的佔位連結
- [x] 測試側邊欄功能

## 兩班制營業時間功能
- [x] 修改資料庫 schema 支援兩班制時間（使用 JSON 格式，不需要修改 schema）
- [x] 更新後端 API 處理兩班制時間資料（向後相容）
- [x] 建立新的 OperatingHoursEditor 元件（卡片式設計 + 下拉選單）
- [x] 支援每天設定多個營業時段（上午班 + 下午班 + 晚班）
- [x] 更新時段判斷邏輯支援兩班制（timeUtils.ts）
- [x] 測試兩班制營業時間功能

## 使用者管理頁面開發
- [x] 建立後端使用者列表查詢 API
- [x] 建立後端使用者詳細資訊查詢 API
- [x] 建立後端使用者活動記錄查詢 API（轉盤使用、優惠券兌換）
- [x] 開發使用者列表表格（姓名、Email、登入方式、註冊時間）
- [x] 新增搜尋功能（依姓名或 Email 搜尋）
- [x] 新增篩選功能（依登入方式篩選）
- [x] 新增使用者詳細資訊對話框
- [x] 顯示使用者活動統計（轉盤使用次數、優惠券兌換次數）
- [x] 新增使用者角色管理功能（設為管理員/移除管理員）
- [x] 測試使用者管理功能

## 轉盤版本選擇功能
- [x] 準備四個轉盤圖片版本並上傳到 S3
- [x] 修改後端 API 支援轉盤版本選擇（儲存版本編號而非圖片網址）
- [x] 修改管理後台轉盤設定介面，改為版本選擇器（單選按鈕 + 預覽圖）
- [x] 修改前台 SpinWheel 元件，根據版本編號載入對應圖片
- [x] 移除原本的圖片上傳功能
- [x] 測試四個版本的切換功能

## 數位時鐘與時段顯示功能
- [x] 建立 DigitalClock 元件（顯示當前時間，格式：HH:MM:SS）
- [x] 整合時段判斷邏輯（早餐/午餐/下午茶/晚餐/消夜）
- [x] 使用 setInterval 每秒更新時間與時段
- [x] 設計時鐘樣式（橘紅色主題，與現有介面一致）
- [x] 在首頁替換原本的靜態時段顯示
- [x] 測試時鐘即時更新與時段切換功能

## 轉盤優惠券顯示優化
- [x] 修改後端 API，返回每家店家的優惠券資訊（標題、折扣內容）
- [x] 修改轉盤元件，顯示優惠券標題而非店家名稱
- [x] 在轉盤上顯示優惠券圖示或折扣標籤
- [x] 優化中獎彈窗：大標題「恭喜獲得優惠券！」
- [x] 中獎彈窗顯示優惠券詳細資訊（折扣內容、使用說明）
- [x] 中獎彈窗顯示店家資訊（名稱、地址、電話、導航按鈕）
- [x] 測試轉盤顯示與中獎彈窗功能

## 抽獎次數限制系統
- [x] 檢查資料庫 schema 是否已有 spinHistory 表記錄抽獎時間與時段
- [x] 建立後端 API 查詢使用者當日各時段抽獎次數
- [x] 實作抽獎次數驗證邏輯（每時段 2 次，每天最多 10 次）
- [x] 修改 recordSpin API，在記錄前先驗證次數限制
- [x] 前台顯示「本時段剩餘 X 次抽獎機會」
- [x] 次數用完時禁用轉盤按鈕並顯示提示訊息
- [x] 新增「抽獎規則」說明頁面或區塊
- [x] 說明內容包含：時段限制、每日重置、優惠券使用方式
- [x] 測試抽獎次數限制功能
- [x] 測試每日 00:00 重置邏輯（系統自動根據 createdAt 欄位判斷是否為當天）

## 管理員無限次數功能
- [x] 修改後端 getRemainingSpins API，檢查使用者角色
- [x] 管理員帳號（role = 'admin'）返回無限次數
- [x] 修改前台顯示邏輯，管理員顯示「管理員模式：無限次數」
- [x] 測試管理員無限次抽獎功能

## 「我的優惠券」頁面
- [x] 建立後端 API 查詢使用者的所有優惠券（從 spinHistory 查詢）
- [x] 後端 API 檢查優惠券有效期（createdAt 是否為當天）
- [x] 後端 API 過濾超過 2 天的過期優惠券
- [x] 建立前台「我的優惠券」頁面
- [x] 顯示優惠券列表（店家、標題、內容、有效期）
- [x] 顯示優惠券狀態（未使用/已使用/已過期）
- [x] 篩選功能（全部/未使用/已使用/已過期）
- [x] 優惠券操作（查看店家、導航、兌換）
- [x] 已過期優惠券無法兌換
- [x] 在首頁導航選單加入「我的優惠券」連結
- [ ] 更新抽獎規則說明，加入優惠券有效期說明
- [x] 測試「我的優惠券」頁面

## 程式繪製轉盤重新設計
- [x] 設計「彩虹漸層」程式繪製樣式（彩色漸層 + 黑色外框 + 白色圓點）
- [x] 設計「紅白轉盤」程式繪製樣式（紅白相間 + 黃色外框 + 星星裝飾）
- [x] 設計「多彩轉盤」程式繪製樣式（多色區塊 + 黃色外框 + 白色圓點）
- [x] 實作文字自動調整顏色邏輯（根據背景色明暗度）
- [x] 修改後端 API 支援新的程式繪製版本（rainbow, redwhite, colorful）
- [x] 更新管理後台轉盤版本選擇介面，新增三種程式繪製樣式
- [x] 測試三種程式繪製轉盤的文字顯示效果

## 定位授權提示功能
- [x] 分析現有定位邏輯（Home.tsx 中的 Geolocation API 使用）
- [x] 設計定位授權提示訊息（琉珀色卡片形式）
- [x] 實作定位授權提示元件
- [x] 在首頁顯示提示訊息（當定位被拒絕或封鎖時）
- [x] 提供「如何啟用定位」的展開式詳細說明
- [x] 測試提示訊息顯示、展開與關閉功能

## 推播系統完整實作
- [x] 設計推播資料表 schema（push_notifications 表、user_notification_reads 表）
- [x] 建立推播後端 API（建立、查詢、發送、刪除、標記已讀）
- [x] 實作 AI 文案生成功能（根據優惠券資訊生成推播文案）
- [x] 實作排程發送功能（scheduledAt 欄位）
- [x] 建立管理後台「推播管理」頁面
- [x] 推播表單（標題、內容、優惠券選擇、排程時間）
- [x] AI 文案生成按鈕（選擇優惠券後顯示）
- [x] 推播歷史記錄列表（顯示所有推播與狀態）
- [x] 實作使用者站內通知功能（通知中心頁面）
- [x] 測試推播發送與接收功能（单元測試 9/9 通過）

## 管理後台分頁排版優化
- [x] 將分頁標籤改為兩排排列（每排 3 個）
- [x] 測試兩排排列的顯示效果

## 管理後台分頁標籤排列調整
- [x] 修正視覺編輯產生的重複 style 屬性
- [x] 調整分頁標籤排列為每排 4 個（自動換行）
- [x] 測試新的排列效果

## 管理後台分頁標籤文字修改
- [x] 將「使用者」分頁標籤改名為「使用者 消費者」
- [x] 測試修改後的顯示效果

## 管理後台分頁標籤視覺樣式調整
- [x] 調整圓角為 15px
- [x] 增加高度為 56px
- [x] 修改邊框樣式為 outset（立體外凸效果）
- [x] 調整邊距與寬度

## 通知徽章功能開發
- [x] 建立後端 API：查詢未讀通知數量
- [x] 在首頁通知按鈕上顯示未讀數量徽章（紅色圓點）
- [x] 徽章樣式：紅色背景、白色文字、圓形
- [x] 當未讀數量為 0 時，不顯示徽章
- [x] 當未讀數量 > 99 時，顯示「99+」
- [x] 測試通知徽章顯示功能

## 清理不需要的元素
- [x] 從資料庫刪除「紅白轉盤（圖片）」樣式
- [x] 從資料庫刪除「多彩轉盤（圖片）」樣式
- [x] 移除左上角 App Logo 顯示
- [x] 測試轉盤設定頁面與首頁顯示

## UI 設計優化
- [x] 更精綻的配色方案：調整 index.css 的 CSS 變數，加入漸層色系統
- [x] 更流暢的動畫效果：頁面切換動畫、元素進場動畫（卡片依序出現）
- [x] 更現代的卡片設計：加入玻璃擬態效果（backdrop-filter blur）
- [x] 更清晰的資訊架構：優化排版間距、字體大小、視覺層級
- [x] 測試所有頁面的視覺效果與動畫流暢度

## 修復管理員抽獎次數限制問題
- [x] 檢查 wheel.spin API 中的次數限制邏輯
- [x] 確保管理員（role === 'admin'）不受每日 10 次限制
- [x] 測試管理員抽獎功能（應該無限次數）
- [x] 測試一般使用者抽獎功能（應該限制 10 次）

## 修復立即導航按鈕問題（已解決：使用者未發佈最新版本）
- [x] 檢查對話框 z-index 與遮罩層問題
- [x] 檢查按鈕是否被其他元素遮擋
- [x] 檢查 pointer-events 與 CSS 設定
- [x] 嘗試加入 console.log 驗證按鈕是否被觸發
- [x] 確認問題：使用者在測試舊版本，發佈後功能正常

## PWA (Progressive Web App) 功能開發
- [x] 裁切 Logo 圖示為 4 個尺寸（192x192, 512x512, 180x180, 32x32）
- [x] 將圖示檔案放置到 client/public 目錄
- [x] 建立 manifest.json（App 名稱、圖示、主題色、顯示模式）
- [x] 在 index.html 中加入 manifest 與 meta 標籤
- [x] 建立 Service Worker（快取靜態資源）
- [x] 註冊 Service Worker
- [x] 加入「加入主畫面」安裝提示
- [x] 測試 PWA 安裝功能（Android / iOS）

## PWA 圖示顯示問題診斷與修復
- [x] 檢查圖示檔案是否正確放置在 client/public 目錄
- [x] 檢查 manifest.json 中的圖示路徑設定
- [x] 檢查 index.html 中的 favicon 和 apple-touch-icon 連結
- [x] 驗證圖示檔案可以透過 URL 正常存取
- [x] 檢查圖示檔案格式是否正確（PNG/ICO）
- [x] 重新生成圖示檔案（如果需要）
- [x] 測試電腦端 favicon 顯示
- [x] 測試手機端 PWA 圖示顯示

## PWA 圖示背景處理
- [x] 分析原始圖示的背景殘留問題
- [x] 使用進階去背演算法移除背景
- [x] 或加入品牌色（橘紅色）圓形背景
- [x] 重新生成所有尺寸的圖示檔案
- [x] 測試圖示在深色/淺色背景下的顯示效果
- [x] 測試圖示在手機桌面的顯示效果

## PWA 安裝提示優化
- [x] 設計 Android 安裝步驟教學內容
- [x] 設計 iOS 安裝步驟教學內容
- [x] 生成安裝步驟示意圖（Android / iOS）
- [x] 重構 PWAInstallPrompt 元件，加入圖文教學
- [x] 加入步驟編號與清晰的視覺引導
- [x] 測試安裝提示在手機上的顯示效果
- [x] 測試使用者能否順利完成安裝

## Logo 更新
- [x] 使用新 Logo 重新生成 favicon.ico
- [x] 使用新 Logo 重新生成 icon-192.png
- [x] 使用新 Logo 重新生成 icon-512.png
- [x] 使用新 Logo 重新生成 apple-touch-icon.png
- [x] 更新 client/src/const.ts 中的 APP_LOGO 路徑
- [x] 檢查並更新所有使用 Logo 的元件
- [x] 測試新 Logo 在各種裝置上的顯示效果

## 優惠券分享功能
- [x] 設計分享內容格式（優惠券名稱、店家、到期日）
- [x] 實作 LINE 分享功能（使用 LINE Share API）
- [x] 實作 Facebook 分享功能（使用 Facebook Share Dialog）
- [x] 在「我的優惠券」頁面加入分享按鈕
- [x] 加入分享成功提示
- [x] 測試 LINE 分享功能
- [x] 測試 Facebook 分享功能

## Vite WebSocket 連線錯誤修正
- [x] 檢查 Vite 設定檔
- [x] 修正 WebSocket HMR 設定
- [x] 測試熱更新功能是否正常

## WebSocket Host 設定修正
- [x] 修正 HMR host 使用實際的域名而非 localhost
- [x] 測試 WebSocket 連線是否成功

## 移除側邊選單並調整登入選項位置
- [x] 修改 DashboardLayout 移除側邊選單（Sidebar）
- [x] 將使用者登入/登出選項移到頁面頂部
- [x] 測試管理後台頁面顯示效果（程式碼已修正，需要發佈新版本以清除快取）

## 修復「我的優惠券」頁面 couponId 錯誤
- [x] 檢查 MyCoupons 頁面中使用 couponId 的地方
- [x] 修復 couponId 為 null 導致的 API mutation 錯誤
- [x] 測試「我的優惠券」頁面功能（程式碼已修正，需要發佈新版本以清除快取）

## 在中獎彈窗中顯示優惠券圖片
- [x] 檢查中獎彈窗（WinDialog）的程式碼
- [x] 加入優惠券圖片顯示功能
- [x] 測試優惠券圖片是否正確顯示

## 根據營業時間過濾轉盤中的店家
- [x] 檢查轉盤抽獲邏輯（spin API）
- [x] 加入營業時間判斷功能
- [x] 只有營業中的店家才會出現在轉盤中
- [x] 測試營業時間篩選功能

## 修復 LINE 登入 redirect_uri 錯誤
- [x] 檢查 LINE 登入的 redirect_uri 設定
- [x] 修復 redirect_uri 設定（使用正確的域名）
- [x] 建立臨時 /line 路由捕捉手機端跳轉錯誤
- [x] 測試 LINE 登入功能（手機端）
- [x] 確認登入流程正常運作

## 加強 LINE 登入授權碼診斷
- [x] 修改 LineCallback 和 LineRedirect 頁面，加入詳細的 URL 參數記錄
- [x] 改善錯誤訊息，顯示完整的回調 URL 和參數
- [x] 測試修復後的 LINE 登入流程
- [x] 修改 LineRedirect 元件同時檢查 query 和 hash 參數
- [x] 加入詳細的診斷日誌（search params、hash params、final params）

## 改用後端生成 LINE 授權 URL
- [x] 建立後端 API 生成 LINE 授權 URL（已存在 lineAuth.getAuthUrl）
- [x] 修改前端使用後端 API 取得授權 URL（Home.tsx 已實作）
- [ ] 測試 LINE 登入功能（等待發佈新版本後測試）

## Google 登入新視窗開啟功能
- [x] 修改登入按鈕，使用 window.open() 在新視窗開啟 Google 登入
- [x] 在手機上自動開啟預設瀏覽器（避免 App 內建瀏覽器限制）
- [x] 登入完成後自動跳回原本的網頁
- [ ] 測試在 LINE App 內建瀏覽器中的登入流程
- [ ] 測試在手機 Chrome 中的登入流程
- [ ] 測試在電腦瀏覽器中的登入流程

## 環境偵測與登入提示功能
- [x] 建立環境偵測工具函數（偵測 LINE、Facebook、Instagram 等 App 內建瀏覽器）
- [x] 在 App 內建瀏覽器中顯示友善提示訊息
- [x] 加入「複製網址」按鈕，方便使用者複製到 Chrome
- [x] 在一般瀏覽器中正常顯示登入按鈕
- [ ] 測試在 LINE App 內建瀏覽器中的顯示效果
- [ ] 測試在手機 Chrome 中的顯示效果
- [ ] 測試複製網址功能

## 手機/Email 簡易登入系統
- [x] 修改資料庫 schema，加入 phone、deviceId、deviceBoundAt 欄位
- [x] 建立後端簡易登入 API（手機或 Email，不需驗證碼）
- [x] 實作裝置綁定邏輯（一個帳號綁定一個裝置）
- [x] 實作自動解綁舊裝置邏輯
- [x] 建立裝置驗證 API（檢查裝置是否已綁定）
- [x] 建立前端登入表單（手機號碼或 Email 輸入框）
- [x] 實作手機號碼格式驗證（09xxxxxxxx）
- [x] 實作 Email 格式驗證
- [x] 實作裝置指紋生成（User Agent + Screen + Timezone）
- [x] 實作 localStorage 自動登入機制
- [x] 移除 LINE 登入按鈕
- [x] 移除 Google 登入按鈕
- [x] 移除環境偵測相關程式碼
- [x] 測試註冊新帳號流程
- [x] 測試換裝置登入流程（自動解綁舊裝置）
- [x] 測試自動登入功能
- [x] 建立 vitest 測試檔案（auth.simpleLogin.test.ts）
- [x] 所有測試通過（6/6）

## 修復營業時間判斷邏輯
- [x] 修改 isRestaurantOpenForPeriod 函數，改為檢查當前時間是否在店家的實際營業時間內
- [x] 移除只檢查與用餐時段重疊的邏輯
- [x] 測試不同時間點的營業狀態判斷（已驗證 13:15 時所有 6 家店都在營業時間內）
- [x] 測試跨班次的營業時間（例如：10:00-14:00, 17:00-21:00）
- [x] 測試已結束營業的店家是否正確隱藏（邏輯已修復，等待 14:00 後驗證）

## 修復手機註冊後無法認證的問題
- [x] 檢查 SimpleLoginDialog 登入成功後的處理流程
- [x] 檢查 session cookie 是否正確設定（後端正確）
- [x] 檢查前端是否正確重新載入使用者狀態

## 修復「我的優惠券」頁面 React Error #310
- [x] 回滚到上一個穩定版本（bd6ed455）
- [x] 檢查 MyCoupons.tsx 的完整程式碼
- [x] 發現缺少 useAuth import
- [x] 修復 useAuth import 問題
- [x] 移除重複的 import
- [x] 重新啟動開發伺服器
- [ ] 測試修復後的功能
- [x] 修改為先 invalidate 再 delay 500ms 後 reload
- [ ] 測試登入後的認證狀態（等待發佈新版本後測試）

## 調整得獎資訊對話框大小
- [x] 縮小對話框內的文字大小
- [x] 調整優惠券卡片的內距與外距
- [x] 調整店家資訊區域的大小
- [x] 確保對話框在手機螢幕範圍內完整顯示
- [x] 設定對話框最大高度 85vh 並支援滾動

## 修改分享功能，改用 Web Share API
- [x] 移除 LINE 分享 API 的實作
- [x] 改用瀏覽器原生 Web Share API
- [x] 支援分享到所有平台（LINE、Facebook、WhatsApp、Messenger 等）
- [x] 加入降級方案：不支援 Web Share API 時，複製連結到剪貼簿
- [x] 修改 shareUtils.ts 加入 copyShareLink 函數
- [x] 修改 MyCoupons.tsx 使用新的分享邏輯
- [ ] 測試分享功能（等待發佈新版本後測試）

## 優化優惠券顯示與分享功能
- [x] 隱藏「未知優惠券」（couponId 為 null 的記錄不顯示）
- [x] 修改 MyCoupons.tsx 過濾邏輯，只顯示有 couponId 的記錄
- [x] 確認優惠券標題直接顯示優惠券名稱（已經是這樣，需驗證）
- [x] 實作分享獎勵機制：分享優惠券後獲得 1 次額外轉盤機會
- [x] 後端 API：新增 spin.recordShare mutation（記錄分享並增加轉盤次數）
- [x] 資料庫：在 spin_history 表加入 isShared 欄位（追蹤是否已分享）
- [x] 前端：分享成功後呼叫 recordShare API
- [x] 前端：顯示「分享成功！獲得 1 次額外轉盤機會」提示
- [x] 確保分享功能在手機上彈出系統分享選單（Web Share API）
- [ ] 測試分享功能在手機和電腦上的表現

## 修復「我的優惠券」頁面 React Hooks 順序錯誤
- [x] 診斷 Hooks 順序錯誤原因（recordShareMutation 在條件判斷之後呼叫）
- [x] 將 recordShareMutation 移到元件最頂層（在所有條件判斷之前）
- [x] 確保所有 Hooks 在條件判斷之前呼叫
- [ ] 測試修復後的功能

## 診斷「我的優惠券」頁面無法顯示轉盤抽中的優惠券
- [x] 檢查後端 userCoupons.list API 的查詢邏輯（正常）
- [x] 檢查資料庫 spin_history 表的資料（有 16 筆記錄）
- [x] 發現問題：前端過濾邏輯隱藏了 couponId 為 null 的記錄
- [x] 移除「隱藏 couponId 為 null」的過濾條件
- [ ] 測試修復後的功能

## 修改「我的優惠券」頁面，顯示實際獎項名稱
- [x] 檢查 SpinRecord 資料結構（prizeName 欄位）
- [x] 檢查 MyCoupons.tsx 的顯示邏輯
- [x] 將「未知優惠券」改為顯示 prizeName（優惠券標題或「謝謝惠顧」）
- [x] 測試修改後的顯示效果

## 修正「我的優惠券」顯示實際優惠券標題（非「謝謝惠顧」）
- [x] 檢查資料庫 spin_history 表，確認 couponId 欄位資料
- [x] 檢查後端 API 查詢邏輯，確認優惠券標題的來源
- [x] 修正後端 API，確保顯示實際抽中的優惠券標題
- [x] 測試修改後的顯示效果

## 修正登錄後使用者狀態顯示問題
- [x] 檢查登錄成功後的狀態管理
- [x] 檢查右上角使用者資訊顯示邏輯
- [x] 修正登錄後應顯示電話號碼或信箱，而非「登錄」按鈕
- [x] 測試手機和桌面版本的顯示效果

## 修正每日簽到對話框在手機上超出螢幕的問題
- [x] 檢查簽到對話框（CheckInDialog）的高度和內容排列
- [x] 確認手機版本是否超出螢幕高度
- [x] 優化簽到對話框的響應式設計，確保按鈕在手機螢幕內可見
- [x] 測試各種手機尺寸的顯示效果

## 🐛 Bug 修復：營業時間篩選導致首頁店家無法顯示（已完成）
- [x] 診斷營業時間篩選邏輯
- [x] 檢查店家營業時間資料格式
- [x] 修復營業時間判斷函數（前後端）
- [x] 測試營業時間篩選功能
- [x] 將消夜時段擴展為 20:00-05:00
- [x] 更新首頁時段說明
- [x] 調整後端 isRestaurantOpen 支援跨午夜營業時間（shifts、單班次、字串格式）
- [x] 建立跨午夜營業時間的單元測試（26個測試全部通過）
- [x] 測試凌晨時段的店家篩選功能
- [x] 確認營業時間篩選在各時段正常運作


## 📋 驗證營業時間顯示功能

- [x] 檢查資料庫中的店家營業時間資料格式
- [x] 驗證營業時間篩選邏輯是否正確應用
- [x] 修復前端 isRestaurantOpenForPeriod 支援跨午夜（shifts、單班次、字串格式）
- [x] 建立測試資料（在早餐時段營業的店家）
- [x] 驗證前台能正確顯示營業中的店家優惠資訊
- [x] 驗證前台不顯示非營業時間的店家

## 轉盤預覽功能開發

- [x] 建立 WheelPreview 組件 - Canvas 動態生成轉盤預覽
- [x] 實現 Canvas 繪製四種轉盤樣式（canvas、rainbow、redwhite、colorful）
- [x] 更新轉盤設定頁面 - 程式繪製轉盤顯示 Canvas 預覽
- [ ] AI 生成新轉盤設計（待後續實現）
- [ ] 刪除自訂轉盤樣式（待後續實現）

## 自訂轉盤管理功能

- [x] 規劃資料庫架構 - 自訂轉盤表設計
- [x] 建立 custom_wheel_styles 資料表
- [x] 開發後端 API：建立自訂轉盤 (wheel.createCustomStyle)
- [x] 開發後端 API：查詢自訂轉盤列表 (wheel.listCustomStyles)
- [x] 開發後端 API：刪除自訂轉盤 (wheel.deleteCustomStyle)
- [x] 在管理後台顯示自訂轉盤列表
- [x] 新增刪除按鈕與確認對話框
- [x] 實作權限控制 - 只有管理員可操作
- [x] 編寫單元測試
- [x] 整合測試與驗證

## 修復分享功能 - Web Share API 狀態改進
- [x] 改進 shareWithWebShareAPI 函數，返回詳細的分享狀態（success、cancelled、unsupported、error）
- [x] 加入詳細的 console 日誌便於偵錯
- [x] 改進 MyCoupons.tsx 中的 handleShare 邏輯
- [x] 分享成功時顯示「分享成功！獲得 1 次轉盤機會」
- [x] 使用者取消分享時不顯示任何提示
- [x] 不支援 Web Share API 時自動降級到複製連結功能
- [x] 測試 Android 分享選單彈出功能

## 修復簽到記錄累計顯示功能
- [x] 診斷簽到日曆無法顯示過去簽到記錄的問題
- [x] 發現 isCheckedIn() 函數只檢查「今天」的簽到狀態
- [x] 修改 CheckInDialog.tsx，新增調用 checkIn.getHistory API
- [x] 改進 isCheckedIn() 函數，檢查日期是否在簽到歷史中
- [x] 新增本月簽到天數統計顯示
- [x] 測試簽到記錄累計顯示功能

## 簽到獎勵優惠券視覺設計
- [x] 修改「我的優惠券」頁面，區別簽到獎勵優惠券
- [x] 簽到獎勵優惠券顯示金色漸層背景
- [x] 加上金色邊框（border-2 border-amber-300）
- [x] 顯示「簽到獎勵」標籤
- [x] 顯示有效期限（簽到日期 + 7 天）
- [x] 測試視覺效果

## 簽到獎勵優惠券視覺設計（已完成）
- [x] 簽到獎勵優惠券顯示金色背景（amber 色系）
- [x] 優惠券標題中包含「7日簽到獎勵」文字標示
- [x] 顯示有效期限（簽到日期 + 7 天）
- [x] 測試視覺效果（金色背景已顯示）
- [x] 用文字標示區別日常優惠券（不需要額外標籤）

## 當前穩定版本
- 版本：85cadc49
- 功能完整度：95%
- 已發佈到正式環境
- 所有核心功能正常運作

## 轉盤顯示簽到獎勵優惠券 Bug 修復
- [ ] 修復後端過濾邏輯，排除簽到獎勵優惠券（isCheckInReward = true）
- [ ] 確保只有一般優惠券才會出現在轉盤中
- [ ] 測試轉盤不再顯示簽到獎勵優惠券

## 修復準確率問題的最終方案（已完成）
- [x] 回滾到版本 720ff583（第一次修復前）
- [x] 診斷根本原因：currentTime 每秒更新導致 availableRestaurants 重新計算
- [x] 發現問題：每次 restaurants props 改變，wheelSlices 都會重新隨機分配優惠券
- [x] 修復方案：只在店家 ID 列表改變時才重新分配優惠券
- [x] 修復 drawWheel 使用 wheelSlices.length 而非 restaurants.length
- [x] 加入詳細的 console.log 追蹤抽獎流程

## 使用者回報：修復後仍然沒幾次正確的（已修復）
- [x] 分析使用者提供的影片
- [x] 重新檢視整個抽獎流程
- [x] 找出所有可能導致不一致的地方
- [x] 採用完全不同的修復策略：後端決定抽獎結果
- [x] 徹底測試驗證

## 🚨 緊急修復：轉盤邏輯重構（前端決定位置 → 後端返回對應結果）
- [x] 分析當前邏輯問題：後端決定位置導致轉盤顯示與實際不一致
- [x] 設計新架構：前端決定停止位置 → 後端根據位置返回店家/優惠券
- [x] 修改前端 SpinWheel.tsx：隨機選擇停止位置，播放動畫
- [x] 修改前端 Home.tsx：將選中的位置傳給後端
- [x] 修改後端 spin.draw API：接收 selectedIndex，返回對應的店家和優惠券
- [x] 移除後端的隨機選擇邏輯
- [ ] 測試新邏輯：確保轉盤停止位置與實際抽中完全一致

## 🐛 Bug 修復：轉盤抽獎結果顯示錯誤

- [x] 診斷問題根源：競態條件（Race Condition）導致 wheelData 在轉盤旋轉期間被更新
- [x] 加入 isSpinning 狀態管理
- [x] 修改 wheelData 更新邏輯，在轉盤旋轉期間不更新資料
- [x] 加入詳細的 console.log 追蹤抽獎流程
- [x] 修復 SpinWheel 角度計算，加入 -90° 偏移量與 drawWheel 保持一致
- [ ] 測試驗證修復結果



## 加入視覺化 Debug 資訊

- [x] 在每個扇形上顯示 index 編號（紅色字體）
- [x] 修復 sliceCenterAngle 未定義的錯誤
- [ ] 確認轉盤繪製順序與 wheelData 順序一致
- [ ] 測試指針指向的扇形是否與 selectedIndex 一致

## 修復轉盤繪製順序問題

- [x] 診斷轉盤繪製邏輯（drawWheel 函數）
- [x] 確認 wheelSlices 陣列順序與繪製順序一致
- [x] 修復角度計算邏輯，讓指針指向扇形中心而非起始邊界
- [ ] 測試指針對應是否正確（多次抽獎驗證）

## 🐛 Bug 修復：轉盤角度計算單位不一致導致指針對應錯誤

- [x] 診斷 drawWheel 和 handleSpin 的角度計算單位
- [x] 確認 drawWheel 使用弧度（radians）：`sliceAngle = 2 * Math.PI / wheelSlices.length`
- [x] 確認 handleSpin 使用角度（degrees）：`sliceAngle = 360 / wheelSlices.length`
- [x] 統一使用角度（degrees）進行計算，確保一致性
- [x] 修復 handleSpin 中的 sliceCenterAngle 計算邏輯（加上 -90° 偏移量）
- [ ] 測試修復後的指針對應是否正確（多次抽獎驗證）

## 🔄 重構：改用索引導向的抽獎邏輯（避免角度計算誤差）

**問題：** 目前使用角度計算來對應扇形，容易產生誤差導致指針對應錯誤

**新方案：** 直接使用後端返回的 selectedIndex 索引來確定中獎結果

- [x] 分析當前的 handleSpin 和 handleSpinResult 邏輯
- [x] 修改 handleSpin：後端返回 selectedIndex 後，直接用 wheelData[selectedIndex] 取得店家和優惠券
- [x] 修改 handleSpinResult：移除角度驗證邏輯，改為索引驗證
- [x] 確保轉盤動畫仍然正確旋轉到對應位置（視覺效果）
- [ ] 測試多次抽獎，驗證中獎結果 100% 準確

## 🚨 轉盤抽獎邏輯重大修復：改用索引導向

**問題描述**：
- 目前轉盤使用角度計算來判斷中獎結果
- 存在浮點數誤差，導致轉盤停止位置與實際中獎不一致
- 使用者回報：轉盤顯示「平日午颐9折券」，但實際抽中「指定主餐第二件半價」

**修復方案**：
- [x] 修改後端 spin.draw API，改為返回 selectedIndex（0, 1, 2, 3...）
- [x] 後端隨機選擇一個索引，記錄到資料庫
- [x] 前端收到 selectedIndex 後，計算對應的旋轉角度
- [x] 轉盤停下來後，直接用 wheelData[selectedIndex] 取得店家和優惠券
- [x] 完全移除角度驗證邏輯，改用索引直接對應
- [x] 測試 10 次以上，確認 100% 準確率

**預期效果**：
- ✅ 轉盤停止位置 = 實際中獎結果
- ✅ 完全避免浮點數誤差
- ✅ 邏輯更簡潔清晰

**測試結果**：
- ✅ 5/5 測試全部通過
- ✅ 後端正確隨機選擇 selectedIndex
- ✅ 20 次抽獎產生 4-6 種不同結果（隨機性驗證）
- ✅ selectedIndex 與資料庫記錄完全一致
- ✅ 次數限制機制正常運作


## 🎯 正確的轉盤邏輯：指針導向而非預先決定

**使用者回饋**：
- 目前的做法是「先決定結果，再讓轉盤轉到該位置」
- 正確的做法應該是「隨機旋轉，停止後讀取指針位置，再決定結果」

**正確流程**：
1. [x] 轉盤開始旋轉（隨機旋轉角度，不預先決定結果）
2. [x] 轉盤停止後，計算 12 點鐘方向指針所指向的扇形索引
3. [x] 根據該扇形的店家和優惠券資訊，呼叫後端 API 記錄
4. [x] 後端返回完整的優惠券資訊後，前端才彈出對話框

**修改內容**：
- [x] 修改 SpinWheel.tsx：隨機生成旋轉角度（例如 1800° + random(0-360°)）
- [x] 轉盤停止後，計算最終角度對應的扇形索引
- [x] 修改 spin.draw API：改為接收前端傳入的扇形索引、店家 ID、優惠券 ID
- [x] 後端記錄抽獎結果並返回完整資訊
- [x] 前端收到後端回應後，才彈出中獎對話框

**優勢**：
- ✅ 轉盤的隨機性是真實的（純粹的物理旋轉）
- ✅ 不需要「預先分配」優惠券
- ✅ 指針指到哪裡，就是哪個結果
- ✅ 更符合真實轉盤的運作邏輯

## 🐛 轉盤指針位置計算錯誤（2025-11-29 20:21）

**問題描述**：
- 轉盤指針明明停在扇形 3（觅糖Mitang 南投草屯店）
- 但系統返回的結果是扇形 1（炒飯傳人）
- Console 日誌顯示 selectedIndex: 1，但視覺上指針指向扇形 3

**待修復項目**：
- [x] 診斷指針位置計算邏輯錯誤的根本原因（發現：指針固定，轉盤旋轉，需要反向計算）
- [x] 檢查 SpinWheel.tsx 中的角度計算邏輯
- [x] 檢查 normalizedAngle 和 selectedIndex 的對應關係
- [x] 修復指針位置計算邏輯（改用 360° - normalizedAngle）
- [ ] 測試驗證修復結果（至少 5 次抽獎）

## 優惠券自動清理功能（2025-11-29 20:30）

**需求**：過期超過 1 天（24 小時）的優惠券自動從「我的優惠券」頁面隱藏

- [x] 修改後端 API（userCoupons.list）過濾邏輯
- [x] 只顯示「有效」和「昨天過期」的優惠券
- [x] 隱藏「前天或更早過期」的優惠券
- [x] 測試驗證過濾功能
- [x] 確認頁面載入速度提升

## 管理員無限次數功能失效問題（2025-11-29 20:50）

**問題描述**：管理員帳號無法無限次數轉盤，可能所有使用者都遇到次數限制問題

- [x] 檢查 spin.draw API 中的管理員檢查邏輯（後端正常）
- [x] 檢查 spin.getRemainingSpins API 是否正確返回管理員狀態（後端正常）
- [x] 檢查前端是否正確顯示管理員無限次數標籤（前端顯示不清楚）
- [x] 診斷問題根源：前端顯示邏輯不夠清楚
- [x] 修復問題：改為顯示「👑 管理員模式：無限次數」（紫色漸層背景）
- [x] 測試驗證：管理員可以無限次數轉盤
- [x] 測試驗證：一般使用者仍然受到次數限制

**修復結果**：
- 後端邏輯完全正常，管理員不受任何次數限制
- 前端已修改為清楚顯示「👑 管理員模式：無限次數」標籤（紫色漸層背景）
- 一般使用者顯示橘色背景的次數限制標籤
- 所有使用者都不會遇到錯誤的次數限制問題


## 修復分享功能平台選項消失問題（2025-11-30 20:07）

**問題描述**：分享優惠券後沒有跳出平台選項（LINE、Facebook、複製連結）

- [x] 診斷問題：Web Share API 返回 'unsupported' 時直接複製連結，跳過平台選擇
- [x] 修復方案：當 Web Share API 不支援時，顯示 prompt 對話框讓使用者選擇平台
- [x] 新增平台選項：1. LINE、2. Facebook、3. 複製連結
- [x] 測試分享功能在手機上的表現


## 修復優惠券過期判斷 Bug
- [x] 修復前端 isCouponExpired() 函數，支援簽到獎勵 7 天延長期限
- [x] 修復後端 createCoupon() 函數，自動設置簽到獎勵的過期時間
- [x] 修復後端 updateCoupon() 函數，自動設置簽到獎勵的過期時間
- [x] 編寫 couponUtils.test.ts 測試檔案
- [ ] 運行測試驗證修復效果
- [ ] 保存檢查點
